var tribe_aggregator=tribe_aggregator||{};tribe_aggregator.fields={selector:{container:".tribe-ea",form:".tribe-ea-form",help:".tribe-ea-help",fields:".tribe-ea-field",dropdown:".tribe-ea-dropdown",origin_field:"#tribe-ea-field-origin",field_url_source:"#tribe-ea-field-url_source",eventbrite_url_source:"#tribe-ea-field-eventbrite_source",import_type_field:".tribe-import-type",media_button:".tribe-ea-media_button",datepicker:".tribe-datepicker",save_credentials_button:".enter-credentials .tribe-save",preview_container:".tribe-preview-container",preview_button:".tribe-preview:visible",refine_filters:".tribe-refine-filters",clear_filters_button:".tribe-clear-filters",finalize_button:".tribe-finalize",cancel_button:".tribe-cancel",schedule_delete_link:".tribe-ea-tab-scheduled a.submitdelete",tab_new:".tribe-ea-tab-new",action:"#tribe-action",view_filters:".tribe-view-filters"},media:{},$:{},construct:{},events:{},import_id:null,result_fetch_count:0,max_result_fetch_count:15,polling_frequency_index:0,polling_frequencies:[500,1e3,5e3,2e4],progress:{},eventbrite:{refineControls:".tribe-refine-filters.eventbrite, .tribe-refine-filters.eventbrite .tribe-refine",refineControlsHideMap:{event:"tr.tribe-refine-filters",organizer:""},detect_type:function(r){if(!tribe_aggregator.source_origin_regexp.eventbrite)return null;var e=tribe_aggregator.source_origin_regexp.eventbrite,t={event:e+"e/[A-z0-9_-]+",organizer:e+"o/[A-z0-9_-]+"},i=void 0;return _.each(t,function(e,t){null!==new RegExp(e,"g").exec(r)&&(i=t)}),i}}},function(x,o,C,j){"use strict";C.init=function(){C.$.container=x(C.selector.container),C.$.form=x(C.selector.form),C.$.action=x(C.selector.action),C.$.fields=C.$.container.find(C.selector.fields),C.$.preview_container=x(C.selector.preview_container),C.origin=x("#tribe-ea-field-origin"),C.importType=x("#tribe-ea-field-url_import_type"),C.urlImport={startDate:x("#tribe-ea-field-url_start"),originalMinDate:x("#tribe-ea-field-url_start").datepicker("option","minDate")||""},x.each(C.construct,function(e,t){t(C.$.fields)});var e=x(document.getElementById("eventDetails"));e.data("datepicker_format")&&(tribe_ev.state.datepicker_format=e.data("datepicker_format")),x(document).on("keypress",C.selector.fields,C.events.trigger_field_change).on("click",C.selector.save_credentials_button,C.events.trigger_save_credentials).on("click",C.selector.clear_filters_button,C.clear_filters).on("click",C.selector.finalize_button,C.finalize_manual_import).on("click",C.selector.preview_button,C.preview_import).on("click",C.selector.cancel_button,C.events.cancel_edit).on("click",C.selector.schedule_delete_link,C.events.verify_schedule_delete).on("click",C.selector.view_filters,C.events.toggle_view_filters).on("blur",C.selector.datepicker,C.date_helper).on("submit",C.selector.tab_new,C.events.suppress_submission).on("change",C.selector.import_type_field,function(){C.reset_preview();var e=x(this),t=x(this).next(C.selector.fields),r=e.val();t.select2("val","schedule"===r?"daily":"").change(),C.$.form.attr("data-type",r),C.maybeLimitUrlStartDate()}).on("change",C.selector.origin_field,function(){var e=x(this).val();C.$.form.attr("data-origin",e),C.reset_preview(),x(".tribe-bumpdown-active").removeClass("tribe-bumpdown-active"),x(".tribe-bumpdown:visible").hide(),"redirect"===x(this).val()&&(window.open("https://theeventscalendar.com/wordpress-event-aggregator/?utm_source=importoptions&utm_medium=plugin-tec&utm_campaign=in-app","_blank"),location.reload()),C.maybeLimitUrlStartDate()}).on("change",C.selector.eventbrite_url_source,function(e){x(C.eventbrite.refineControls).show();var t=C.eventbrite.detect_type(x("#tribe-ea-field-eventbrite_source").val());if(t){var r=C.eventbrite.refineControlsHideMap[t];r&&x(r).hide()}}).on("change",C.selector.field_url_source,function(e){var r=x(this).val(),i=null;if(r&&(o.each(j.source_origin_regexp,function(e,t){null!==new RegExp(e,"g").exec(r)&&(i=t)}),null!=i)){var t=x(C.selector.origin_field);if(t.find('option[value="'+i+'"]').length){var a=x("#tribe-ea-field-url_import_type"),n=a.val(),s=null;"schedule"===n&&(s=x("#tribe-ea-field-url_import_frequency").val()),a.val(""),t.val(i).trigger("change"),x("#tribe-ea-field-"+i+"_import_type").val(n).trigger("change"),"schedule"===n&&x("#tribe-ea-field-"+i+"_import_frequency").val(s).trigger("change"),"eventbrite"===i&&(x("#tribe-ea-field-"+i+"_source_type_url").trigger("click"),x("#tribe-ea-field-"+i+"_import_source").val("source_type_url").trigger("change")),x("#tribe-ea-field-"+i+"_source").val(r).trigger("change")}}}),x(".tribe-dependency").change(),tribe_timepickers.setup_timepickers(x(tribe_timepickers.selector.timepicker)),"edit"===C.$.action.val()&&(C.$.form.addClass("edit-form"),x(C.selector.finalize_button).html(j.l10n.edit_save)),"object"==typeof tribe_aggregator_save&&C.progress.init()},C.preview_import=function(e){if(e.preventDefault(),(i=x(".tribe-ea-form.tribe-validation")).trigger("validation.tribe"),!tribe.validation.hasErrors(i)){C.reset_polling_counter();x(".tribe-fetch-warning-message").html("");var t=x("#tribe-post_id");t.data("value",t.val()),t.val("");var r=x("#tribe-import_id");r.data("value",r.val()),r.val("");var i,a=x(C.selector.preview_button),n=(i=a.closest("form")).serialize();t.val(t.data("value")),r.val(t.data("value")),C.$.preview_container.addClass("tribe-fetching").removeClass("tribe-fetch-error"),C.$.form.removeClass("show-data"),a.prop("disabled",!0);var s=x(".dataTable").data("table");void 0!==s&&s.clear().draw(),"edit"===C.$.action.val()?C.preview_save_import(n):C.create_import(n)}},C.reset_polling_counter=function(){C.polling_frequency_index=0,C.result_fetch_count=0},C.reset_form=function(){C.$.fields.val("").trigger("change"),x(".tribe-ea-dropdown").select2("data",null),x('[id$="import_frequency"]').val("daily").trigger("change"),C.$.form.removeClass("show-data")},C.reset_preview=function(){C.$.form.removeClass("show-data"),x(".tribe-fetched, .tribe-fetching, .tribe-fetch-error").removeClass("tribe-fetched tribe-fetching tribe-fetch-error")},C.clear_filters=function(){x(C.selector.refine_filters).find("input, select").val("").trigger("change")},C.preview_save_import=function(e){x.ajax({type:"POST",url:ajaxurl+"?action=tribe_aggregator_preview_import",data:e,dataType:"json"}).done(C.handle_preview_create_results)},C.create_import=function(e){x.ajax({type:"POST",url:ajaxurl+"?action=tribe_aggregator_create_import",data:e,dataType:"json"}).done(C.handle_preview_create_results)},C.handle_preview_create_results=function(e){if(!e.success){var t=e.data;return o.isString(t)||(t=t.message),void C.display_fetch_error(["<b>",j.l10n.preview_fetch_error_prefix,"</b>"," "+t].join(" "))}if(C.import_id=e.data.data.import_id,x("#tribe-import_id").val(C.import_id),void 0!==e.data.data.items)return C.init_datatable(e.data.data),void C.$.preview_container.removeClass("tribe-fetching").addClass("tribe-fetched");C.$.container.find(".spinner-message").html(j.l10n.preview_polling[0]),setTimeout(C.poll_for_results,C.polling_frequencies[C.polling_frequency_index])},C.poll_for_results=function(){C.result_fetch_count++,x.ajax({type:"GET",url:ajaxurl+"?action=tribe_aggregator_fetch_import&import_id="+C.import_id,dataType:"json"}).done(function(e){if(void 0!==e.data.warning&&e.data.warning){var t=e.data.warning;C.display_fetch_warning(["<b>",j.l10n.preview_fetch_warning_prefix,"</b>"," "+t].join(" "))}var r;if(!e.success)return void 0!==e.data.message?r=e.data.message:void 0!==e.data[0].message&&(r=e.data[0].message),void C.display_fetch_error(["<b>",j.l10n.preview_fetch_error_prefix,"</b>"," "+r].join(" "));"error"===e.data.status?C.display_fetch_error(e.data.message):"success"!==e.data.status?(C.result_fetch_count>C.max_result_fetch_count&&(C.polling_frequency_index++,C.$.container.find(".spinner-message").html(j.l10n.preview_polling[C.polling_frequency_index]),C.result_fetch_count=0),void 0===C.polling_frequencies[C.polling_frequency_index]?C.display_fetch_error(j.l10n.preview_timeout):setTimeout(C.poll_for_results,C.polling_frequencies[C.polling_frequency_index])):(e.data.data.items=e.data.data.events,C.init_datatable(e.data.data),C.$.preview_container.removeClass("tribe-fetching").addClass("tribe-fetched"),x(C.selector.preview_button).prop("disabled",!1))})},C.init_datatable=function(e){var t=!1,r="csv"===($=x(C.selector.origin_field).val()),i="eventbrite"===$,a=x('[id$="import_type"]:visible'),n="manual";if(void 0!==j.default_settings[$])for(var s in j.default_settings[$]){if(j.default_settings[$].hasOwnProperty(s))x("#tribe-ea-field-"+s).val(j.default_settings[$][s]).select2("val",j.default_settings[$][s]).trigger("change")}if(a.length&&(n=x("#"+a.first().attr("id").replace("s2id_","")).val()),"manual"!==n||e.items.length){a.length&&"manual"!==n||(t=!0);var o=C.$.preview_container.find(".data-container table"),l=[];for(var c in e.items){var d=e.items[c];d.checkbox=t?'<input type="checkbox">':"",d.all_day?d.start_time=j.l10n.all_day:(void 0!==d.start_meridian&&d.start_meridian||(11<parseInt(d.start_hour,10)?d.start_meridian=j.l10n.pm:d.start_meridian=j.l10n.am),12<d.start_hour&&(d.start_hour=d.start_hour-12),d.start_time=(0===parseInt(d.start_hour,10)?12:d.start_hour)+":"+("00"+d.start_minute).slice(-2),d.start_time+=" "+d.start_meridian),l.push(d)}t&&!r?o.addClass("display-checkboxes"):o.removeClass("display-checkboxes"),C.$.form.addClass("show-data");var _,p={lengthMenu:[[5,10,25,50,-1],[5,10,25,50,tribe_l10n_datatables.pagination.all]],order:[[1,"asc"]],columnDefs:[{cellType:"th",className:"check-column",orderable:!1,targets:0}],data:l};if(i&&(p.order=[[1,"desc"]]),void 0!==e.columns){p.columns=[{data:"checkbox"}];var u=o.find("thead tr"),f=o.find("tfoot tr"),g=x({}),v="",m="";if(u.find("th:first").nextAll().remove(),f.find("th:first").nextAll().remove(),r){var b=o.closest(".data-container");o.closest(".data-container").addClass("csv-data"),b.find(".tribe-preview-message .tribe-csv-filename").html(x("#tribe-ea-field-csv_file_name").text()),u.closest("thead").prepend('<tr class="tribe-column-map"><th scope="row" class="check-column column-cb"></th></tr>'),g=x(".tribe-column-map"),m=(m=x("#tribe-ea-field-csv_content_type").val()).replace("tribe_",""),v=x("#tribe-csv-column-map-"+m).html()}var h=0;for(c in e.columns){if(p.columns.push({data:e.columns[c]}),u.append('<th scope="col">'+e.columns[c]+"</th>"),f.append('<th scope="col">'+e.columns[c]+"</th>"),r){var w=e.columns[c].toLowerCase().replace(/^\s+|\s+$/g,"").replace(/\s/g,"_").replace(/[^a-z0-9_]/,"");g.append('<th scope="col">'+v.replace('name="column_map[]"','name="aggregator[column_map]['+h+']" id="column-'+h+'"')+"</th>");var y=g.find("#column-"+h);void 0!==j.csv_column_mapping[m][h]&&(w=j.csv_column_mapping[m][h]),y.find('option[value="'+w+'"]').prop("selected",!0)}h++}p.scrollX=!0}else p.columns=[{data:"checkbox"},{data:"start_date"},{data:"start_time"},{data:"end_date"},{data:"title"}],p.autoWidth=!1;o.tribeDataTable(p),C.wrap_cell_content(),o.on("select.dt",C.events.twiddle_finalize_button_text).on("deselect.dt",C.events.twiddle_finalize_button_text).on("draw.dt",C.wrap_cell_content),"new"===C.$.action.val()&&(_="manual"===n&&r?j.l10n.import_all_no_number:"manual"===n?j.l10n.import_all.replace("%d",l.length):j.l10n.create_schedule),x(C.selector.finalize_button).html(_)}else{var $=e.origin,k=void 0!==j.l10n[$]&&void 0!==j.l10n[$].no_results?j.l10n[$].no_results:j.l10n.no_results;C.display_fetch_error(k)}},C.wrap_cell_content=function(){x(".dataTable").find("tbody td").each(function(){var e=x(this);e.html('<div class="tribe-td-height-limit">'+e.html()+"</div>")})},C.display_fetch_error=function(e){var t=x(".tribe-fetch-error-message");C.$.preview_container.removeClass("tribe-fetching").addClass("tribe-fetch-error"),t.html(""),C.display_error(t,e),x(C.selector.preview_button).prop("disabled",!1)},C.display_fetch_warning=function(e){var t=x(".tribe-fetch-warning-message");C.$.preview_container.removeClass("tribe-fetching").addClass("tribe-fetch-warning"),t.html(""),C.display_warning(t,e)},C.display_error=function(e,t){e.prepend(['<div class="notice notice-error">',"<p>",t,"</p>","</div>"].join(""))},C.display_warning=function(e,t){e.prepend(['<div class="notice notice-warning">',"<p>",t,"</p>","</div>"].join(""))},C.display_success=function(e,t){e.prepend(['<div class="notice notice-success">',"<p>",t,"</p>","</div>"].join(""))},C.save_credentials=function(t){var e=t.find(".tribe-fieldset").find("input").serialize(),r=ajaxurl+"?action=tribe_aggregator_save_credentials";x.post(r,e).done(function(e){e.success&&(t.addClass("credentials-entered"),t.find('[name="has-credentials"]').val(1).change())})},C.finalize_manual_import=function(){var e=x("#tribe-ea-field-origin").val(),t=x(".dataTable"),r=window.tribe_data_table;if(t.hasClass("display-checkboxes")){var i=r.rows({selected:!0});if(i[0].length||(i=r.rows()),!i[0].length)return void C.display_error(x(".tribe-finalize-container"),j.l10n.events_required_for_manual_submit);var a=i.data(),n=[],s=null;if("meetup"===e?s="meetup_id":"eventbrite"===e?s="eventbrite_id":"ical"===e||"ics"===e||"gcal"===e?s="uid":"url"===e&&(s="id"),null!==s){for(var o in a)isNaN(o)||void 0!==a[o][s]&&n.push(a[o][s]);x("#tribe-selected-rows").text(JSON.stringify(n))}else x("#tribe-selected-rows").text("all")}else x("#tribe-selected-rows").text("all");x(".dataTables_scrollBody").find('[name^="aggregator[column_map]"]').remove(),C.$.form.submit()},C.search_id=function(e){var t=null;return void 0!==e.id?t=e.id:void 0!==e.ID?t=e.ID:void 0!==e.value&&(t=e.value),null==e?null:t},C.construct.dropdown=function(e){var t=function(e){var t=x(e.element);return"string"==typeof t.data("subtitle")&&(e.text=e.text+'<br><span class="tribe-dropdown-subtitle">'+t.data("subtitle")+"</span>"),e.text},r={formatResult:t,formatSelection:t,escapeMarkup:function(e){return e}};return tribe_dropdowns.dropdown(e.filter(".tribe-ea-dropdown"),r),e},C.construct.media_button=function(e){var t=e.filter(C.selector.media_button);return"undefined"!=typeof wp&&wp.media&&wp.media.editor&&(t.each(function(){var e=x(this),t=e.data("input"),r=x("#"+t),i=x("#"+t+"_name"),a=C.media[t]=wp.media({title:e.data("mediaTitle"),library:{type:e.data("mimeType")},multiple:!1});a.on("select",function(){var e=a.state().get("selection");e&&e.each(function(e){r.data({id:e.attributes.id,text:e.attributes.title}),r.val(e.attributes.id),r.change(),i.html(e.attributes.filename),i.attr("title",e.attributes.filename)})})}),C.$.container.on("click",C.selector.media_button,function(e){if(e.preventDefault(),x(this).is(":visible")){var t=x(this).data("input");return C.media[t].open(t),!1}})),t},C.events.trigger_field_change=function(){x(this).change()},C.events.trigger_save_credentials=function(){C.save_credentials(x(this).closest(".enter-credentials"))},C.events.suppress_submission=function(e){x("#tribe-ea-field-origin").val();if(x("#tribe-selected-rows").val().length)return!0;e.preventDefault()},C.events.twiddle_finalize_button_text=function(e,t){if("new"===C.$.action.val()){var r=t.rows({selected:!0})[0].length,i=j.l10n.import_checked;r||(i=j.l10n.import_all,r=t.rows()[0].length),i=i.replace("%d",r),x(C.selector.finalize_button).html(i)}},C.events.cancel_edit=function(e){e.preventDefault();var t=window.location.href;t=(t=t.replace("tab=edit","tab=scheduled")).replace(/id=\d+/,""),window.location.href=t},C.events.verify_schedule_delete=function(){return confirm(j.l10n.verify_schedule_delete)},C.events.toggle_view_filters=function(e){e.preventDefault();var t=x(this);t.toggleClass("tribe-active"),t.is(".tribe-active")?t.html(j.l10n.hide_filters):t.html(j.l10n.view_filters)},C.progress.init=function(){C.progress.data={},C.progress.$={},C.progress.$.notice=x(".tribe-notice-aggregator-update-msg"),C.progress.$.spinner=C.progress.$.notice.find("img"),C.progress.$.progress=C.progress.$.notice.find(".progress"),C.progress.$.tracker=C.progress.$.notice.find(".tracker"),C.progress.$.created=C.progress.$.tracker.find(".track-created .value"),C.progress.$.updated=C.progress.$.tracker.find(".track-updated .value"),C.progress.$.skipped=C.progress.$.tracker.find(".track-skipped .value"),C.progress.$.remaining=C.progress.$.tracker.find(".track-remaining .value"),C.progress.$.bar=C.progress.$.notice.find(".bar"),C.progress.data.time=Date.now(),setTimeout(C.progress.start)},C.progress.start=function(){C.progress.send_request(),C.progress.update(tribe_aggregator_save.progress,tribe_aggregator_save.progressText)},C.progress.handle_response=function(e){var t=Date.now()-C.progress.data.time;e.html&&C.progress.data.notice.html(e.html),isNaN(parseInt(e.progress,10))||C.progress.update(e),e.continue&&(t<500?setTimeout(C.progress.send_request,500-t):C.progress.send_request()),e.error?(C.progress.$.notice.find(".tribe-message").html(e.error_text),C.progress.$.tracker.remove(),C.progress.$.notice.find(".progress-container").remove(),C.progress.$.notice.removeClass("warning").addClass("error")):e.complete&&(C.progress.$.notice.find(".tribe-message").html(e.complete_text),C.progress.$.tracker.remove(),C.progress.$.notice.find(".progress-container").remove(),C.progress.$.notice.removeClass("warning").addClass("completed"))},C.progress.send_request=function(){var e={record:tribe_aggregator_save.record_id,check:tribe_aggregator_save.check,action:"tribe_aggregator_realtime_update"};x.post(ajaxurl,e,C.progress.handle_response,"json")},C.progress.update=function(e){var t=parseInt(e.progress,10);if(!(t<0||100<t)&&void 0!==e.counts){var r=["created","updated","skipped"];for(var i in r)if(e.counts[r[i]]){var a=e.counts[r[i]],n=C.progress.$[r[i]];if("updated"===r[i]||"skipped"===r[i])(n?n.html():0)<a&&n.html(a);else n.html(a);C.progress.$.tracker.hasClass("has-"+r[i])||C.progress.$.tracker.addClass("has-"+r[i])}C.progress.$.bar.css("width",t+"%"),C.progress.$.progress.attr("title",e.progress_text)}},C.progress.remove_notice=function(){C.progress.$.notice.animate({opacity:0,height:"toggle"},1e3,function(){C.progress.$.notice.remove()})},C.date_helper=function(){var e;if((e=x(this)).hasClass("tribe-datepicker")){var t=e.val();if(""!==t&&null!==t){var r=e.attr("id").match("tribe-ea-field-(.*)_start")[1];""!==r&&null!==r&&jQuery("#tribe-date-helper-date-"+r).html(t)}}},C.maybeLimitUrlStartDate=function(){"url"===C.origin.val()&&("schedule"!==C.importType.val()?C.urlImport.startDate.data("datepicker-min-date",null):C.urlImport.startDate.data("datepicker-min-date","today"))},x(document).ready(C.init)}(jQuery,_,tribe_aggregator.fields,tribe_aggregator);