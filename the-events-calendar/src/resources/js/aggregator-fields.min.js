var tribe_aggregator=tribe_aggregator||{};tribe_aggregator.fields={selector:{container:".tribe-ea",form:".tribe-ea-form",help:".tribe-ea-help",fields:".tribe-ea-field",dropdown:".tribe-ea-dropdown",origin_field:"#tribe-ea-field-origin",import_type_field:".tribe-import-type",media_button:".tribe-ea-media_button",datepicker:".tribe-datepicker",save_credentials_button:".enter-credentials .tribe-save",preview_container:".tribe-preview-container",preview_button:".tribe-preview:visible",refine_filters:".tribe-refine-filters",clear_filters_button:".tribe-clear-filters",finalize_button:".tribe-finalize",cancel_button:".tribe-cancel",schedule_delete_link:".tribe-ea-tab-scheduled a.submitdelete",tab_new:".tribe-ea-tab-new",action:"#tribe-action",view_filters:".tribe-view-filters"},media:{},$:{},construct:{},events:{},import_id:null,result_fetch_count:0,max_result_fetch_count:15,polling_frequency_index:0,polling_frequencies:[500,1e3,5e3,2e4],progress:{}},function(e,t,r,a){"use strict";r.init=function(){r.$.container=e(r.selector.container),r.$.form=e(r.selector.form),r.$.action=e(r.selector.action),r.$.fields=r.$.container.find(r.selector.fields),r.$.preview_container=e(r.selector.preview_container),e.each(r.construct,function(e,t){t(r.$.fields)});var t=e(document.getElementById("eventDetails"));t.data("datepicker_format")&&(tribe_ev.state.datepicker_format=t.data("datepicker_format")),e(document).on("keypress",r.selector.fields,r.events.trigger_field_change).on("click",r.selector.save_credentials_button,r.events.trigger_save_credentials).on("click",r.selector.clear_filters_button,r.clear_filters).on("click",r.selector.finalize_button,r.finalize_manual_import).on("click",r.selector.preview_button,r.preview_import).on("click",r.selector.cancel_button,r.events.cancel_edit).on("click",r.selector.schedule_delete_link,r.events.verify_schedule_delete).on("click",r.selector.view_filters,r.events.toggle_view_filters).on("blur",r.selector.datepicker,r.date_helper).on("submit",r.selector.tab_new,r.events.suppress_submission).on("change",r.selector.import_type_field,function(){r.reset_preview();var t=e(this),a=e(this).next(r.selector.fields);a.select2("val","schedule"===t.val()?"daily":"").change(),r.$.form.attr("data-type",t.val())}).on("change",r.selector.origin_field,function(){r.$.form.attr("data-origin",e(this).val()),r.reset_preview(),e(".tribe-bumpdown-active").removeClass("tribe-bumpdown-active"),e(".tribe-bumpdown:visible").hide(),e('.tribe-ea-tab-new .tribe-ea-dropdown:not([id$="tribe-ea-field-origin"])').select2("val","").change(),e(".tribe-ea-tab-new .tribe-ea-form input").val(function(){return this.defaultValue}).change(),"redirect"===e(this).val()&&(window.open("https://theeventscalendar.com/wordpress-event-aggregator/?utm_source=importoptions&utm_medium=plugin-tec&utm_campaign=in-app","_blank"),location.reload())}),e(".tribe-dependency").change(),tribe_timepickers.setup_timepickers(e(tribe_timepickers.selector.timepicker)),"edit"===r.$.action.val()&&(r.$.form.addClass("edit-form"),e(r.selector.finalize_button).html(a.l10n.edit_save)),"object"==typeof tribe_aggregator_save&&r.progress.init()},r.preview_import=function(){r.reset_polling_counter();var t=(e(".tribe-fetch-warning-message").html(""),e("#tribe-post_id"));t.data("value",t.val()),t.val("");var a=e("#tribe-import_id");a.data("value",a.val()),a.val("");var i=e(r.selector.preview_button),n=i.closest("form"),s=n.serialize();t.val(t.data("value")),a.val(t.data("value")),r.$.preview_container.addClass("tribe-fetching").removeClass("tribe-fetch-error"),r.$.form.removeClass("show-data"),i.prop("disabled",!0);var o=e(".dataTable").data("table");"undefined"!=typeof o&&o.clear().draw(),"edit"===r.$.action.val()?r.preview_save_import(s):r.create_import(s)},r.reset_polling_counter=function(){r.polling_frequency_index=0,r.result_fetch_count=0},r.reset_form=function(){r.$.fields.val("").trigger("change"),e(".tribe-ea-dropdown").select2("data",null),e('[id$="import_frequency"]').val("daily").trigger("change"),r.$.form.removeClass("show-data")},r.reset_preview=function(){r.$.form.removeClass("show-data"),e(".tribe-fetched, .tribe-fetching, .tribe-fetch-error").removeClass("tribe-fetched tribe-fetching tribe-fetch-error")},r.clear_filters=function(){e(r.selector.refine_filters).find("input, select").val("").trigger("change")},r.preview_save_import=function(t){var a=e.ajax({type:"POST",url:ajaxurl+"?action=tribe_aggregator_preview_import",data:t,dataType:"json"});a.done(r.handle_preview_create_results)},r.create_import=function(t){var a=e.ajax({type:"POST",url:ajaxurl+"?action=tribe_aggregator_create_import",data:t,dataType:"json"});a.done(r.handle_preview_create_results)},r.handle_preview_create_results=function(t){return t.success?(r.import_id=t.data.data.import_id,e("#tribe-import_id").val(r.import_id),"undefined"!=typeof t.data.data.items?(r.init_datatable(t.data.data),void r.$.preview_container.removeClass("tribe-fetching").addClass("tribe-fetched")):(r.$.container.find(".spinner-message").html(a.l10n.preview_polling[0]),void setTimeout(r.poll_for_results,r.polling_frequencies[r.polling_frequency_index]))):void r.display_fetch_error(["<b>",a.l10n.preview_fetch_error_prefix,"</b>"," "+t.data.message].join(" "))},r.poll_for_results=function(){r.result_fetch_count++;var t=e.ajax({type:"GET",url:ajaxurl+"?action=tribe_aggregator_fetch_import&import_id="+r.import_id,dataType:"json"});t.done(function(t){if("undefined"!=typeof t.data.warning&&t.data.warning){var i=t.data.warning;r.display_fetch_warning(["<b>",a.l10n.preview_fetch_warning_prefix,"</b>"," "+i].join(" "))}if(!t.success){var n;return"undefined"!=typeof t.data.message?n=t.data.message:"undefined"!=typeof t.data[0].message&&(n=t.data[0].message),void r.display_fetch_error(["<b>",a.l10n.preview_fetch_error_prefix,"</b>"," "+n].join(" "))}"error"===t.data.status?r.display_fetch_error(t.data.message):"success"!==t.data.status?(r.result_fetch_count>r.max_result_fetch_count&&(r.polling_frequency_index++,r.$.container.find(".spinner-message").html(a.l10n.preview_polling[r.polling_frequency_index]),r.result_fetch_count=0),"undefined"==typeof r.polling_frequencies[r.polling_frequency_index]?r.display_fetch_error(a.l10n.preview_timeout):setTimeout(r.poll_for_results,r.polling_frequencies[r.polling_frequency_index])):(t.data.data.items=t.data.data.events,r.init_datatable(t.data.data),r.$.preview_container.removeClass("tribe-fetching").addClass("tribe-fetched"),e(r.selector.preview_button).prop("disabled",!1))})},r.init_datatable=function(t){var i=!1,n=e(r.selector.origin_field).val(),s="csv"===n,o=e('[id$="import_type"]:visible'),l="manual";if("undefined"!=typeof a.default_settings[n])for(var c in a.default_settings[n])if(a.default_settings[n].hasOwnProperty(c)){var d=e("#tribe-ea-field-"+c);d.val(a.default_settings[n][c]).select2("val",a.default_settings[n][c]).trigger("change")}if(o.length&&(l=e("#"+o.first().attr("id").replace("s2id_","")).val()),"manual"===l&&!t.items.length){var n=t.origin,p="undefined"!=typeof a.l10n[n]&&"undefined"!=typeof a.l10n[n].no_results,u=p?a.l10n[n].no_results:a.l10n.no_results;return void r.display_fetch_error(u)}o.length&&"manual"!==l||(i=!0);var _=r.$.preview_container.find(".data-container table"),f=[];for(var g in t.items){var m=t.items[g];m.checkbox=i?'<input type="checkbox">':"",m.all_day?m.start_time=a.l10n.all_day:("undefined"!=typeof m.start_meridian&&m.start_meridian||(parseInt(m.start_hour,10)>11?m.start_meridian=a.l10n.pm:m.start_meridian=a.l10n.am),m.start_hour>12&&(m.start_hour=m.start_hour-12),m.start_time=(0===parseInt(m.start_hour,10)?12:m.start_hour)+":"+("00"+m.start_minute).slice(-2),m.start_time+=" "+m.start_meridian),f.push(m)}i&&!s?_.addClass("display-checkboxes"):_.removeClass("display-checkboxes"),r.$.form.addClass("show-data");var v={lengthMenu:[[5,10,25,50,-1],[5,10,25,50,tribe_l10n_datatables.pagination.all]],order:[[1,"asc"]],columnDefs:[{cellType:"th",className:"check-column",orderable:!1,targets:0}],data:f};if("undefined"!=typeof t.columns){v.columns=[{data:"checkbox"}];var h=_.find("thead tr"),b=_.find("tfoot tr"),w=e({}),y="",x="";if(h.find("th:first").nextAll().remove(),b.find("th:first").nextAll().remove(),s){var $=_.closest(".data-container");_.closest(".data-container").addClass("csv-data"),$.find(".tribe-preview-message .tribe-csv-filename").html(e("#tribe-ea-field-csv_file_name").text()),h.closest("thead").prepend('<tr class="tribe-column-map"><th scope="row" class="check-column column-cb"></th></tr>'),w=e(".tribe-column-map"),x=e("#tribe-ea-field-csv_content_type").val(),x=x.replace("tribe_","");var k=e("#tribe-csv-column-map-"+x);y=k.html()}var C=0;for(g in t.columns){if(v.columns.push({data:t.columns[g]}),h.append('<th scope="col">'+t.columns[g]+"</th>"),b.append('<th scope="col">'+t.columns[g]+"</th>"),s){var S=t.columns[g].toLowerCase().replace(/^\s+|\s+$/g,"").replace(/\s/g,"_").replace(/[^a-z0-9_]/,"");w.append('<th scope="col">'+y.replace('name="column_map[]"','name="aggregator[column_map]['+C+']" id="column-'+C+'"')+"</th>");var j=w.find("#column-"+C);"undefined"!=typeof a.csv_column_mapping[x][C]&&(S=a.csv_column_mapping[x][C]),j.find('option[value="'+S+'"]').prop("selected",!0)}C++}v.scrollX=!0}else v.columns=[{data:"checkbox"},{data:"start_date"},{data:"start_time"},{data:"end_date"},{data:"title"}],v.autoWidth=!1;_.tribeDataTable(v),r.wrap_cell_content(),_.on("select.dt",r.events.twiddle_finalize_button_text).on("deselect.dt",r.events.twiddle_finalize_button_text).on("draw.dt",r.wrap_cell_content);var T;"new"===r.$.action.val()&&(T="manual"===l&&s?a.l10n.import_all_no_number:"manual"===l?a.l10n.import_all.replace("%d",f.length):a.l10n.create_schedule),e(r.selector.finalize_button).html(T)},r.wrap_cell_content=function(){e(".dataTable").find("tbody td").each(function(){var t=e(this);t.html('<div class="tribe-td-height-limit">'+t.html()+"</div>")})},r.display_fetch_error=function(t){var a=e(".tribe-fetch-error-message");r.$.preview_container.removeClass("tribe-fetching").addClass("tribe-fetch-error"),a.html(""),r.display_error(a,t),e(r.selector.preview_button).prop("disabled",!1)},r.display_fetch_warning=function(t){var a=e(".tribe-fetch-warning-message");r.$.preview_container.removeClass("tribe-fetching").addClass("tribe-fetch-warning"),a.html(""),r.display_warning(a,t)},r.display_error=function(e,t){e.prepend(['<div class="notice notice-error">',"<p>",t,"</p>","</div>"].join(""))},r.display_warning=function(e,t){e.prepend(['<div class="notice notice-warning">',"<p>",t,"</p>","</div>"].join(""))},r.display_success=function(e,t){e.prepend(['<div class="notice notice-success">',"<p>",t,"</p>","</div>"].join(""))},r.save_credentials=function(t){var r=t.find(".tribe-fieldset").find("input").serialize(),a=ajaxurl+"?action=tribe_aggregator_save_credentials",i=e.post(a,r);i.done(function(e){e.success&&(t.addClass("credentials-entered"),t.find('[name="has-credentials"]').val(1).change())})},r.finalize_manual_import=function(){var t=e("#tribe-ea-field-origin").val(),i=e(".dataTable"),n=window.tribe_data_table;if("eventbrite"===t)return void r.$.form.submit();if(i.hasClass("display-checkboxes")){var s=n.rows({selected:!0});if(s[0].length||(s=n.rows()),!s[0].length)return void r.display_error(e(".tribe-finalize-container"),a.l10n.events_required_for_manual_submit);var o=s.data(),l=[],c=null;if("facebook"===t?c="facebook_id":"meetup"===t?c="meetup_id":"ical"===t||"ics"===t||"gcal"===t?c="uid":"url"===t&&(c="id"),null!==c){for(var d in o)isNaN(d)||"undefined"!=typeof o[d][c]&&l.push(o[d][c]);e("#tribe-selected-rows").text(JSON.stringify(l))}else e("#tribe-selected-rows").text("all")}else e("#tribe-selected-rows").text("all");e(".dataTables_scrollBody").find('[name^="aggregator[column_map]"]').remove(),r.$.form.submit()},r.search_id=function(e){var t=null;return"undefined"!=typeof e.id?t=e.id:"undefined"!=typeof e.ID?t=e.ID:"undefined"!=typeof e.value&&(t=e.value),void 0==e?null:t},r.construct.dropdown=function(a){var i=a.filter(r.selector.dropdown).not(".select2-offscreen, .select2-container");return i.each(function(){var a=e(this),i={};if(a.is("select")||(i.id=r.search_id),i.allowClear=!0,a.is("[data-prevent-clear]")&&(i.allowClear=!1),a.is("[data-options]")&&(i.data=a.data("options")),a.is("[data-hide-search]")&&(i.minimumResultsForSearch=1/0),i.upsellFormatter=function(t){var r=e(t.element);return"string"==typeof r.data("subtitle")&&(t.text=t.text+'<br><span class="tribe-dropdown-subtitle">'+r.data("subtitle")+"</span>"),t.text},"tribe-ea-field-origin"===a.attr("id")&&(i.formatResult=i.upsellFormatter,i.formatSelection=i.upsellFormatter,i.escapeMarkup=function(e){return e}),a.is("[multiple]")&&(i.multiple=!0,t.isArray(a.data("separator"))?i.tokenSeparators=a.data("separator"):i.tokenSeparators=[a.data("separator")],i.separator=a.data("separator"),i.regexSeparatorElements=["^("],i.regexSplitElements=["(?:"],e.each(i.tokenSeparators,function(e,t){i.regexSeparatorElements.push("[^"+t+"]+"),i.regexSplitElements.push("["+t+"]")}),i.regexSeparatorElements.push(")$"),i.regexSplitElements.push(")"),i.regexSeparatorString=i.regexSeparatorElements.join(""),i.regexSplitString=i.regexSplitElements.join(""),i.regexToken=new RegExp(i.regexSeparatorString,"ig"),i.regexSplit=new RegExp(i.regexSplitString,"ig")),i.matcher=function(e,a){var n=0==a.toUpperCase().indexOf(e.toUpperCase());if(!n&&"undefined"!=typeof i.tags){var s=t.where(i.tags,{text:a});if(i.tags.length>0&&t.isObject(s)){var o=r.search_id(s[0]);n=0==o.toUpperCase().indexOf(e.toUpperCase())}}return n},a.is("[data-tags]")&&(i.tags=a.data("options"),i.initSelection=function(r,a){var n=[];e(r.val().split(i.regexSplit)).each(function(){var e={id:this,text:this};if(i.tags.length>0&&t.isObject(i.tags[0])){var r=t.where(i.tags,{value:this});r.length>0&&(e=r[0],e={id:e.value,text:e.text})}n.push(e)}),a(n)},i.createSearchChoice=function(e,t){if(e.match(i.regexToken))return{id:e,text:e}},0===i.tags.length&&(i.formatNoMatches=function(){return a.attr("placeholder")})),a.is("[data-source]")){var n=a.data("source");i.data={results:[]},i.escapeMarkup=function(e){return e},i.ajax={dataType:"json",type:"POST",url:window.ajaxurl,results:function(e){return e.data}},i.ajax.data=function(e,t){return{action:"tribe_aggregator_dropdown_"+n}}}a.select2(i)}).on("change",function(r){var a=e(this),i=e(this).data("value");a.is("[multiple]")&&a.is("[data-source]")&&(r.added?t.isArray(i)?i.push(r.added):i=[r.added]:i=t.isArray(i)?t.without(i,r.removed):[],a.data("value",i).attr("data-value",JSON.stringify(i)))}),i},r.construct.media_button=function(t){var a=t.filter(r.selector.media_button);return"undefined"!=typeof wp&&wp.media&&wp.media.editor?(a.each(function(){var t=e(this),a=t.data("input"),i=e("#"+a),n=e("#"+a+"_name"),s=r.media[a]=wp.media({title:t.data("mediaTitle"),library:{type:t.data("mimeType")},multiple:!1});s.on("select",function(){var e=s.state(),t=e.get("selection");t&&t.each(function(e){i.data({id:e.attributes.id,text:e.attributes.title}),i.val(e.attributes.id),i.change(),n.html(e.attributes.filename),n.attr("title",e.attributes.filename)})})}),r.$.container.on("click",r.selector.media_button,function(t){if(t.preventDefault(),e(this).is(":visible")){var a=e(this).data("input");return r.media[a].open(a),!1}}),a):a},r.events.trigger_field_change=function(){e(this).change()},r.events.trigger_save_credentials=function(){r.save_credentials(e(this).closest(".enter-credentials"))},r.events.suppress_submission=function(t){var r=e("#tribe-ea-field-origin").val();return!(!e("#tribe-selected-rows").val().length&&"eventbrite"!==r)||void t.preventDefault()},r.events.twiddle_finalize_button_text=function(t,i){if("new"===r.$.action.val()){var n=i.rows({selected:!0})[0].length,s=a.l10n.import_checked;n||(s=a.l10n.import_all,n=i.rows()[0].length),s=s.replace("%d",n),e(r.selector.finalize_button).html(s)}},r.events.cancel_edit=function(e){e.preventDefault();var t=window.location.href;t=t.replace("tab=edit","tab=scheduled"),t=t.replace(/id=\d+/,""),window.location.href=t},r.events.verify_schedule_delete=function(){return confirm(a.l10n.verify_schedule_delete)},r.events.toggle_view_filters=function(t){t.preventDefault();var r=e(this);r.toggleClass("tribe-active"),r.is(".tribe-active")?r.html(a.l10n.hide_filters):r.html(a.l10n.view_filters)},r.progress.init=function(){r.progress.data={},r.progress.$={},r.progress.$.notice=e(".tribe-notice-aggregator-update-msg"),r.progress.$.spinner=r.progress.$.notice.find("img"),r.progress.$.progress=r.progress.$.notice.find(".progress"),r.progress.$.tracker=r.progress.$.notice.find(".tracker"),r.progress.$.created=r.progress.$.tracker.find(".track-created .value"),r.progress.$.updated=r.progress.$.tracker.find(".track-updated .value"),r.progress.$.skipped=r.progress.$.tracker.find(".track-skipped .value"),r.progress.$.remaining=r.progress.$.tracker.find(".track-remaining .value"),r.progress.$.bar=r.progress.$.notice.find(".bar"),r.progress.data.time=Date.now(),setTimeout(r.progress.start)},r.progress.start=function(){r.progress.send_request(),r.progress.update(tribe_aggregator_save.progress,tribe_aggregator_save.progressText)},r.progress.handle_response=function(e){var t=Date.now(),a=t-r.progress.data.time;e.html&&r.progress.data.notice.html(e.html),isNaN(parseInt(e.progress,10))||r.progress.update(e),e["continue"]&&(a<500?setTimeout(r.progress.send_request,500-a):r.progress.send_request()),e.complete&&(r.progress.$.notice.find(".tribe-message").html(e.complete_text),r.progress.$.tracker.remove(),r.progress.$.notice.find(".progress-container").remove(),r.progress.$.notice.removeClass("warning").addClass("completed"))},r.progress.send_request=function(){var t={record:tribe_aggregator_save.record_id,check:tribe_aggregator_save.check,action:"tribe_aggregator_realtime_update"};e.post(ajaxurl,t,r.progress.handle_response,"json")},r.progress.update=function(e){var t=parseInt(e.progress,10);if(!(t<0||t>100)&&"undefined"!=typeof e.counts){var a=["created","updated","skipped"];for(var i in a)if(e.counts[a[i]]){var n=e.counts[a[i]],s=r.progress.$[a[i]];if("updated"===a[i]||"skipped"===a[i]){var o=s?s.html():0;n>o&&s.html(n)}else s.html(n);r.progress.$.tracker.hasClass("has-"+a[i])||r.progress.$.tracker.addClass("has-"+a[i])}r.progress.$.bar.css("width",t+"%"),r.progress.$.progress.attr("title",e.progress_text)}},r.progress.remove_notice=function(){var e={opacity:0,height:"toggle"};r.progress.$.notice.animate(e,1e3,function(){r.progress.$.notice.remove()})},r.date_helper=function(){var t;if(t=e(this),t.hasClass("tribe-datepicker")){var r=t.val();if(""!==r&&null!==r){var a=t.attr("id").match("tribe-ea-field-(.*)_start"),i=a[1];""!==i&&null!==i&&jQuery("#tribe-date-helper-date-"+i).html(r)}}},e(document).ready(r.init)}(jQuery,_,tribe_aggregator.fields,tribe_aggregator);